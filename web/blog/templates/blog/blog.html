{% extends "WebApp/estructura.html" %}
{% load static %}

{% block content %}

<div class="container py-5">
    
    <div class="text-center mb-5">
        <h1 class="display-5 font-weight-bold" style="color: var(--color-olive-dark);">Mercado Artesanal</h1>
        <div style="height: 4px; width: 60px; background-color: var(--color-terracotta); margin: 10px auto;"></div>
        <p style="color: var(--color-olive-light);">Piezas únicas curadas por región y técnica.</p>
    </div>

    <div class="row">
        <!-- ================= FILTROS ================= -->
        <div class="col-lg-3 mb-5">
            <div class="bg-white p-4 shadow-sm sticky-top" style="top: 100px; border-radius: var(--radius-xl); border: 1px solid #eee;">
                <h4 class="filter-section-title">Filtros</h4>

                <form class="mattel-form">

                    <div class="form-group mb-4">
                        <label class="font-weight-bold small text-muted">REGIÓN</label>
                        <select class="form-control" name="region">
                            <option value="todas">Todas las regiones</option>
                            {% for region in regiones %}
                                <option value="{{ region.id }}" 
                                    {% if filtros_actuales.region == region.id %}selected{% endif %}>
                                    {{ region.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div class="form-group mb-4">
                        <label class="font-weight-bold small text-muted">TÉCNICA</label>
                        {% for categoria in categorias %}
                        <div class="custom-control custom-checkbox mb-2">
                            <input type="checkbox" class="custom-control-input" 
                                   id="cat{{categoria.id}}" 
                                   name="categoria" 
                                   value="{{ categoria.id }}"
                                   {% if categoria.id in filtros_actuales.categorias %}checked{% endif %}>

                            <label class="custom-control-label" for="cat{{categoria.id}}">
                                {{categoria.nombre}}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                
                    <div class="form-group mb-4">
                        <label class="font-weight-bold small text-muted">PRECIO MÁXIMO</label>
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <span class="small">$0</span>
                            <span class="font-weight-bold" style="color: var(--color-terracotta);" id="precioDisplay">
                                ${{ filtros_actuales.precio_max|default:"5000" }}
                            </span>
                        </div>
                        <input type="range" class="custom-range" 
                               name="precio_max" 
                               min="0" max="5000" step="100"
                               value="{{ filtros_actuales.precio_max|default:'5000' }}"
                               id="precioRange"
                               style="accent-color: var(--color-terracotta);">
                    </div>
                
                    <button type="submit" class="btn btn-mattel btn-block w-100" style="padding: 0.8rem;">
                        Filtrar Resultados
                    </button>

                    <a href="{% url 'Blog' %}" class="btn btn-sm btn-link btn-block mt-2">
                        Limpiar Filtros
                    </a>
                </form>
            </div>
        </div>

        <!-- ================= PRODUCTOS ================= -->
        <div class="col-lg-9">
            <div id="productos-container">
                {% include "blog/partials/productos.html" %}
            </div>
        </div>

    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const form = document.querySelector(".mattel-form");
    const container = document.getElementById("productos-container");
    const rangeInput = document.getElementById('precioRange');
    const priceDisplay = document.getElementById('precioDisplay');

    // Mostrar valor del slider
    rangeInput.addEventListener('input', function() {
        priceDisplay.textContent = '$' + rangeInput.value;
    });

    // -------- FILTROS AJAX --------
    form.addEventListener("submit", function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        container.style.opacity = "0.5";

        fetch(`?${params.toString()}`, {
            headers: { 'x-requested-with': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            container.innerHTML = data.html;
            container.style.opacity = "1";
            window.history.pushState({}, "", `?${params.toString()}`);
        });
    });

    // -------- PAGINACIÓN AJAX --------
    document.addEventListener("click", function(e) {
        if (e.target.closest(".pagination a")) {
            e.preventDefault();

            const url = e.target.closest("a").getAttribute("href");

            container.style.opacity = "0.5";

            fetch(url, {
                headers: { 'x-requested-with': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                container.innerHTML = data.html;
                container.style.opacity = "1";
                window.history.pushState({}, "", url);
            });
        }
    });

});
</script>

{% endblock %}
